#!/bin/bash

# Start Video Proxy Service
# This script starts the edge video proxy service for secure camera streaming

echo "üé• Starting Video Proxy Service"
echo "================================"

# Check if CLI is available
if ! command -v cyberwave &> /dev/null; then
    echo "‚ùå Cyberwave CLI not found"
    echo "   Please install the CLI first:"
    echo "   cd cyberwave-cli && pip3 install -e ."
    exit 1
fi

# Set environment
echo "üåê Setting up environment..."
export CYBERWAVE_ENVIRONMENT="local"

# Check dependencies
echo "üîç Checking video proxy dependencies..."
python3 -c "
try:
    import cv2
    print('‚úÖ OpenCV available')
except ImportError:
    print('‚ùå OpenCV missing - install with: pip install opencv-python')
    exit(1)

try:
    import aiohttp
    print('‚úÖ aiohttp available')
except ImportError:
    print('‚ùå aiohttp missing - install with: pip install aiohttp aiohttp-cors')
    exit(1)

try:
    import websockets
    print('‚úÖ websockets available')
except ImportError:
    print('‚ùå websockets missing - install with: pip install websockets')
    exit(1)

try:
    import numpy as np
    print('‚úÖ numpy available')
except ImportError:
    print('‚ùå numpy missing - install with: pip install numpy')
    exit(1)
"

if [ $? -ne 0 ]; then
    echo ""
    echo "üí° Install missing dependencies:"
    echo "   pip install opencv-python aiohttp aiohttp-cors websockets numpy"
    exit 1
fi

# Show camera configuration
echo ""
echo "üìπ Camera Configuration:"
echo "   NVR Host: 192.168.1.6:554"
echo "   Cameras: 8 Uniview cameras"
echo "   Authentication: Secure (credentials handled by edge node)"
echo ""

# Show service information
echo "üöÄ Starting proxy service..."
echo "   Port: 8001"
echo "   Analysis: Enabled (motion detection)"
echo "   Backend: http://localhost:8000"
echo ""

echo "üì° Service endpoints will be:"
echo "   Streams list:     http://localhost:8001/streams"
echo "   Camera 1 MJPEG:   http://localhost:8001/streams/1/mjpeg"
echo "   Camera 1 snapshot: http://localhost:8001/streams/1/snapshot"
echo "   WebSocket events: ws://localhost:8001/ws"
echo "   Health check:     http://localhost:8001/health"
echo ""

echo "üîó Frontend integration:"
echo "   Devices page:     http://localhost:3000/devices"
echo "   Node page:        http://localhost:3000/nodes/21b0743b-50bf-4e1a-804e-a50499c88198"
echo ""

echo "‚ö†Ô∏è  Important notes:"
echo "   ‚Ä¢ RTSP credentials are secure and not exposed to frontend"
echo "   ‚Ä¢ Motion detection events are sent to backend"
echo "   ‚Ä¢ Streams are converted from RTSP to MJPEG for browser compatibility"
echo "   ‚Ä¢ Press Ctrl+C to stop the service"
echo ""

read -p "üé¨ Ready to start video proxy service? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå Cancelled by user"
    exit 0
fi

echo ""
echo "üé• Starting Video Proxy Service..."
echo "=================================="

# Change to CLI directory
cd "$(dirname "$0")/.."

# Start the video proxy service
cyberwave edge start-video-proxy --port 8001 --analysis

echo ""
echo "‚úÖ Video proxy service stopped"
