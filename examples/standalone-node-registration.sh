#!/bin/bash

# Standalone Node Registration Script
# Registers edge node without requiring a project

set -e

echo "ü§ñ Standalone Edge Node Registration"
echo "==================================="

BACKEND_URL="http://localhost:8000"
API_BASE="${BACKEND_URL}/api/v1"
NODE_ID="edge_9078476a6993daaa"

echo ""
echo "üîê Step 1: Authentication"
echo "========================="

echo "Authenticating with backend..."
auth_response=$(curl -s -X POST \
    -H "Content-Type: application/json" \
    -d '{"email":"admin@cyberwave.com","password":"admin123"}' \
    "$API_BASE/users/auth/cli/login" 2>/dev/null || echo "ERROR")

token=$(echo "$auth_response" | python3 -c "
import json,sys
try:
    data = json.load(sys.stdin)
    print(data['token'])
except:
    print('')
" 2>/dev/null || echo "")

if [ -z "$token" ]; then
    echo "‚ùå Authentication failed"
    echo "Response: $auth_response"
    exit 1
fi

echo "‚úÖ Authentication successful"

echo ""
echo "ü§ñ Step 2: Register Standalone Edge Node"
echo "========================================"

node_data='{
    "name": "ITMACD4NMMQQ7N0 Standalone Edge Node",
    "description": "Standalone edge node with camera capabilities - no project required",
    "hostname": "ITMACD4NMMQQ7N0",
    "node_type": "edge",
    "capabilities": ["camera_discovery", "device_management", "telemetry_collection", "motion_detection"]
}'

echo "Registering standalone node..."

node_response=$(curl -s -X POST \
    -H "Authorization: Token $token" \
    -H "Content-Type: application/json" \
    -d "$node_data" \
    "$API_BASE/nodes" 2>/dev/null || echo "ERROR")

echo "Node registration response: $node_response"

# Extract node UUID
node_uuid=$(echo "$node_response" | python3 -c "
import json,sys
try:
    data = json.load(sys.stdin)
    print(data['uuid'])
except:
    print('')
" 2>/dev/null || echo "")

if [ -z "$node_uuid" ]; then
    echo "‚ùå Node registration failed"
    echo "Response: $node_response"
    exit 1
fi

echo "‚úÖ Node registered with UUID: $node_uuid"

echo ""
echo "üì± Step 3: Register Discovered Devices"
echo "======================================"

# Device 1: IP Camera
echo "Registering IP Camera (192.168.1.6)..."

camera1_data='{
    "name": "IP Camera 192.168.1.6",
    "description": "Auto-discovered IP camera on local network",
    "device_type": "camera",
    "connection_string": "http://192.168.1.6:80",
    "connection_type": "network",
    "manufacturer": "Generic",
    "model": "IP Camera",
    "config": {
        "ip_address": "192.168.1.6",
        "protocol": "http",
        "port": 80,
        "capabilities": ["video_streaming", "motion_detection"]
    },
    "capabilities": ["video_streaming", "motion_detection"]
}'

camera1_response=$(curl -s -X POST \
    -H "Authorization: Token $token" \
    -H "Content-Type: application/json" \
    -d "$camera1_data" \
    "$API_BASE/nodes/$node_uuid/devices" 2>/dev/null || echo "ERROR")

echo "‚úÖ Camera 1 registered"

# Device 2: Uniview NVR
echo ""
echo "Registering Uniview NVR (192.168.1.8)..."

nvr_data='{
    "name": "Uniview NVR 192.168.1.8",
    "description": "Uniview Network Video Recorder with multiple camera streams",
    "device_type": "nvr",
    "connection_string": "rtsp://admin:Stralis26$@192.168.1.8:554",
    "connection_type": "network",
    "manufacturer": "Uniview",
    "model": "NVR System",
    "serial_number": "UNV-NVR-001",
    "config": {
        "ip_address": "192.168.1.8",
        "protocol": "rtsp",
        "port": 554,
        "username": "admin",
        "streams": [
            "unicast/c1/s1/live",
            "unicast/c2/s1/live"
        ],
        "capabilities": ["video_streaming", "recording", "motion_detection", "multi_camera"]
    },
    "capabilities": ["video_streaming", "recording", "motion_detection", "multi_camera"]
}'

nvr_response=$(curl -s -X POST \
    -H "Authorization: Token $token" \
    -H "Content-Type: application/json" \
    -d "$nvr_data" \
    "$API_BASE/nodes/$node_uuid/devices" 2>/dev/null || echo "ERROR")

echo "‚úÖ NVR registered"

echo ""
echo "üìã Step 4: Verify Node in Global List"
echo "====================================="

echo "Fetching all nodes..."
nodes_response=$(curl -s -H "Authorization: Token $token" \
    "$API_BASE/nodes" 2>/dev/null || echo "ERROR")

echo "All nodes response:"
echo "$nodes_response" | python3 -c "
import json,sys
try:
    data = json.load(sys.stdin)
    print(f'Found {len(data)} total nodes:')
    for i, node in enumerate(data, 1):
        project_info = f\" (Project: {node['project_uuid']})\" if node.get('project_uuid') else \" (Standalone)\"
        print(f'{i:2}. {node[\"name\"]} - {node[\"uuid\"][:8]}...{project_info}')
        print(f'    Status: {node[\"status\"]}, Type: {node[\"node_type\"]}')
        print()
except Exception as e:
    print('Error parsing nodes:', e)
    print('Raw response:', data)
"

echo ""
echo "üéâ Registration Complete!"
echo "========================="

echo "‚úÖ Standalone Node: $node_uuid"
echo "‚úÖ Devices: 2 registered"
echo "‚úÖ No project required!"

echo ""
echo "üåê Verification:"
echo "==============="
echo "1. Open: http://localhost:3000/devices"
echo "2. Look for nodes section or standalone devices"
echo "3. Your node should be visible in the main devices list"
echo "4. Check if there's a separate 'Nodes' or 'Edge Nodes' page"

echo ""
echo "üìä Summary:"
echo "==========="
echo "‚Ä¢ Node ID: $NODE_ID"
echo "‚Ä¢ Node UUID: $node_uuid"
echo "‚Ä¢ Project: None (Standalone)"
echo "‚Ä¢ IP Camera: 192.168.1.6:80 (HTTP)"
echo "‚Ä¢ Uniview NVR: 192.168.1.8:554 (RTSP)"
echo "  - Streams: unicast/c1/s1/live, unicast/c2/s1/live"
echo "  - Username: admin"

echo ""
echo "üîó Direct Links:"
echo "==============="
echo "‚Ä¢ Frontend: http://localhost:3000"
echo "‚Ä¢ Devices: http://localhost:3000/devices"
echo "‚Ä¢ Nodes API: $API_BASE/nodes"

echo ""
echo "‚úÖ SUCCESS: Standalone edge node registered!"
echo "The node should now be visible in the frontend without requiring a project."
