# Multi-Camera Setup

Deploy multiple cameras with a single edge service.

## Overview

The Cyberwave edge service supports multiple concurrent video streams. This guide covers:

- Discovering multiple cameras
- Using the `connect` command for quick setup
- Cloud configuration sync with device fingerprinting
- Running a single edge for multiple cameras
- Per-camera ML model configuration

## Discovery

### Scan Network for Cameras

```bash
# Scan local network (port scan only, fastest)
cyberwave-cli scan -t 0.5 --no-onvif --no-upnp

# Full discovery with ONVIF/UPnP (slower but more info)
cyberwave-cli scan

# Scan specific subnet
cyberwave-cli scan -s 192.168.1
```

### Example Output

```
Found 5 device(s)
â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ    â”ƒ IP Address   â”ƒ Port â”ƒ Protocol â”ƒ Manufacturer â”ƒ URL                     â”ƒ
â”¡â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”©
â”‚ ğŸ“· â”‚ 192.168.1.3  â”‚ 554  â”‚ RTSP     â”‚ -            â”‚ rtsp://192.168.1.3:554  â”‚
â”‚ ğŸ“· â”‚ 192.168.1.5  â”‚ 554  â”‚ RTSP     â”‚ -            â”‚ rtsp://192.168.1.5:554  â”‚
â”‚ ğŸ“· â”‚ 192.168.1.10 â”‚ 554  â”‚ RTSP     â”‚ -            â”‚ rtsp://192.168.1.10:554 â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Setup Methods

### Method 1: Smart Connect (Recommended)

The `connect` command creates a twin and configures the edge in one step. Configuration is saved to the cloud and can be restored on any device.

```bash
# Check your device fingerprint first
cyberwave-cli edge whoami

# Connect first camera (creates twin + configures edge)
cyberwave-cli connect camera --name "Front Door"

# Connect additional cameras to the same environment
cyberwave-cli connect camera --name "Backyard" -e ENV_UUID
cyberwave-cli connect camera --name "Garage" -e ENV_UUID
```

The connect command will:
1. Resolve the asset (by registry ID or alias like "camera")
2. Create a new twin in your environment
3. Prompt for camera configuration (RTSP URL, FPS, etc.)
4. Save config to cloud (twin metadata) with your device fingerprint
5. Write local `.env` file

### Method 2: Pull Environment Configs

If cameras are already configured in the cloud (e.g., from another device), pull all configs at once:

```bash
# Pull configs for all twins in environment
cyberwave-cli edge pull -e ENV_UUID

# Example output:
Environment: Home Security
Found 3 twin(s):

  âœ“ Front Door - 1 camera(s)
  âœ“ Backyard - 1 camera(s)
  âœ“ Garage - 1 camera(s)

âœ“ Config pulled to ./.env
  3 camera(s) from 3 twin(s)
```

### Method 3: Manual .env Configuration

For advanced setups, configure all cameras directly in `.env`:

```bash
CAMERAS='[
  {"camera_id": "front_door", "source": "rtsp://admin:pass@192.168.1.3:554/stream", "fps": 10},
  {"camera_id": "backyard", "source": "rtsp://admin:pass@192.168.1.5:554/stream", "fps": 10},
  {"camera_id": "garage", "source": "rtsp://admin:pass@192.168.1.10:554/stream", "fps": 5}
]'
```

## Device Fingerprinting

Each edge device has a unique fingerprint based on hardware characteristics:

```bash
$ cyberwave-cli edge whoami

Device Information

Fingerprint: macbook-pro-a1b2c3d4e5f6
Hostname:    macbook-pro.local
Platform:    Darwin-arm64
Python:      3.11.0
MAC:         a4:83:e7:xx:xx:xx
```

This fingerprint is used to:
- Track which device connected to which twin
- Store per-device configurations in twin metadata
- Enable cloud config sync across devices

Override the fingerprint if needed:
```bash
export CYBERWAVE_EDGE_UUID=my-custom-device-id
```

## Cloud Configuration Sync

Configurations are stored in twin metadata and synced to the cloud:

```python
# twin.metadata.edge_configs
{
  "macbook-pro-a1b2c3d4e5f6": {
    "cameras": [{"camera_id": "default", "source": "rtsp://...", "fps": 10}],
    "device_info": {"hostname": "macbook-pro.local", "platform": "Darwin-arm64"},
    "registered_at": "2026-01-13T10:00:00Z",
    "last_sync": "2026-01-13T12:00:00Z"
  }
}
```

### Sync Workflows

**New device, existing twins:**
```bash
cyberwave-cli edge pull -e ENV_UUID
```

**Push config to new device:**
```bash
# On the new device
cyberwave-cli edge pull -t TWIN_UUID
# Will prompt to copy config from existing device
```

## Edge Configuration

### Complete .env Example

```bash
# Cyberwave Edge Configuration
# Generated by: cyberwave twin create --pair / edge pull

# Required
CYBERWAVE_TOKEN=your-api-token
CYBERWAVE_TWIN_UUID=primary-twin-uuid
CYBERWAVE_BASE_URL=http://localhost:8000

# Device Identification (auto-generated)
CYBERWAVE_EDGE_UUID=macbook-pro-a1b2c3d4e5f6

# Camera Configuration
CAMERAS='[
  {"camera_id": "front_door", "source": "rtsp://admin:pass@192.168.1.3:554/stream", "fps": 10, "twin_uuid": "twin-1"},
  {"camera_id": "backyard", "source": "rtsp://admin:pass@192.168.1.5:554/stream", "fps": 10, "twin_uuid": "twin-2"},
  {"camera_id": "garage", "source": "rtsp://admin:pass@192.168.1.10:554/stream", "fps": 5, "twin_uuid": "twin-3"}
]'

# Local development
CYBERWAVE_LOCAL_ICE=true

# Logging
LOG_LEVEL=INFO
```

### Per-Camera ML Models

```bash
MODELS='{
  "front_door_yolo": {
    "runtime": "ultralytics",
    "model_path": "yolov8s.pt",
    "camera_id": "front_door",
    "classes": ["person", "car"],
    "confidence_threshold": 0.6,
    "event_types": ["person_detected"]
  },
  "backyard_motion": {
    "runtime": "motion",
    "model_path": "mog2",
    "camera_id": "backyard",
    "event_types": ["motion_detected"]
  }
}'
```

## Running

### Start Edge Service

```bash
# From project root
python -m cyberwave_edge.service

# Or with explicit env file
cyberwave-cli edge start --env-file /path/to/.env

# Check status
cyberwave-cli edge status
cyberwave-cli edge remote-status -t TWIN_UUID
```

### Monitor Cameras

```bash
# Watch edge logs
tail -f /tmp/edge.log | grep -E "camera|frame|event"

# List active models
cyberwave-cli edge list-models --twin-uuid TWIN_UUID
```

### MQTT Commands

```bash
# Stop a camera
mosquitto_pub -t "localcyberwave/twin/TWIN_UUID/command" \
  -m '{"command": "stop_video", "camera": "backyard"}'

# Start a camera
mosquitto_pub -t "localcyberwave/twin/TWIN_UUID/command" \
  -m '{"command": "start_video", "camera": "garage"}'
```

## Resource Management

| Cameras | Model | Recommended Setup |
|---------|-------|-------------------|
| 1-2 | YOLOv8s | Single edge, CPU |
| 3-5 | YOLOv8n | Single edge, GPU recommended |
| 5+ | YOLOv8n | Multiple edges or cloud offload |

### Reducing Load

1. **Lower FPS:** `{"fps": 5}`
2. **Reduce inference:** `{"inference_fps": 1.0}`
3. **Lighter models:** `{"model_path": "yolov8n.pt"}`
4. **Selective detection:** `{"classes": ["person"]}`

## Quick Reference

| Command | Description |
|---------|-------------|
| `cyberwave-cli scan` | Discover cameras on network |
| `cyberwave-cli edge whoami` | Show device fingerprint |
| `cyberwave-cli connect camera` | Create twin + configure edge |
| `cyberwave-cli edge pull -e UUID` | Pull all configs from environment |
| `cyberwave-cli edge pull -t UUID` | Pull config from single twin |
| `cyberwave-cli edge remote-status -t UUID` | Check edge heartbeat |
| `cyberwave-cli edge start` | Start edge service |

## Troubleshooting

### Camera Not Found

```bash
# Test RTSP connectivity
ffprobe "rtsp://admin:pass@192.168.1.3:554/stream"

# Check twin exists
cyberwave-cli twin show TWIN_UUID
```

### Config Not Syncing

```bash
# Check fingerprint matches
cyberwave-cli edge whoami

# Re-pull config
cyberwave-cli edge pull -t TWIN_UUID -y
```

### High CPU Usage

- Reduce inference FPS
- Use YOLOv8n instead of larger models
- Enable GPU if available
