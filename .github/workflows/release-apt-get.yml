name: Release to Package Registries

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.1.0)"
        required: true
        type: string

env:
  PACKAGE_NAME: cyberwave-cli
  # Buildkite Package Registries configuration
  BUILDKITE_ORG_SLUG: cyberwave
  BUILDKITE_DEB_REGISTRY_SLUG: cli
  BUILDKITE_APK_REGISTRY_SLUG: cli-alpine

jobs:
  build-deb:
    name: Build Debian Package (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[build]"

      - name: Build binary with PyInstaller
        run: |
          chmod +x build.sh
          ./build.sh
          echo "‚úÖ Binary built successfully"
          ls -la dist/

      - name: Verify binary works
        run: |
          ./dist/cyberwave-cli --version || ./dist/cyberwave-cli --help
          echo "‚úÖ Binary verification passed"

      - name: Create Debian package structure
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          PKG_DIR="${PACKAGE_NAME}_${VERSION}_${ARCH}"

          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/usr/bin"
          mkdir -p "${PKG_DIR}/usr/share/doc/${PACKAGE_NAME}"

          # Copy binary
          cp dist/cyberwave-cli "${PKG_DIR}/usr/bin/"
          chmod 755 "${PKG_DIR}/usr/bin/cyberwave-cli"

          # Create control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: ${PACKAGE_NAME}
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: ${ARCH}
          Maintainer: Cyberwave <support@cyberwave.com>
          Homepage: https://cyberwave.com
          Description: The official command-line interface for Cyberwave
           Authenticate and bootstrap robotics projects from your terminal.
           .
           Features:
            - Authenticate with Cyberwave platform
            - Bootstrap robot projects like SO-101
            - Manage device connections
          EOF

          # Remove leading spaces from control file (heredoc artifact)
          sed -i 's/^          //' "${PKG_DIR}/DEBIAN/control"

          # Create copyright file
          cat > "${PKG_DIR}/usr/share/doc/${PACKAGE_NAME}/copyright" << EOF
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: cyberwave-cli
          Upstream-Contact: support@cyberwave.com
          Source: https://github.com/cyberwave-os/cyberwave-cli

          Files: *
          Copyright: $(date +%Y) Cyberwave
          License: MIT
          EOF

          # Create changelog
          cat > "${PKG_DIR}/usr/share/doc/${PACKAGE_NAME}/changelog.Debian" << EOF
          ${PACKAGE_NAME} (${VERSION}) stable; urgency=medium

            * Release ${VERSION}

           -- Cyberwave <support@cyberwave.com>  $(date -R)
          EOF
          gzip -9 "${PKG_DIR}/usr/share/doc/${PACKAGE_NAME}/changelog.Debian"

          echo "‚úÖ Debian package structure created"

      - name: Build .deb package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          PKG_DIR="${PACKAGE_NAME}_${VERSION}_${ARCH}"

          dpkg-deb --build "${PKG_DIR}"
          echo "‚úÖ Debian package built"
          ls -la *.deb

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: "*.deb"
          retention-days: 7

  # build-apk:
  #   name: Build Alpine Package (${{ matrix.arch }})
  #   runs-on: ${{ matrix.runner }}
  #   strategy:
  #     matrix:
  #       include:
  #         - arch: x86_64
  #           runner: ubuntu-latest
  #           platform: linux/amd64
  #         - arch: aarch64
  #           runner: ubuntu-24.04-arm
  #           platform: linux/arm64

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set version from tag or input
  #       id: version
  #       run: |
  #         if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
  #           VERSION="${{ github.event.inputs.version }}"
  #         else
  #           VERSION="${GITHUB_REF#refs/tags/v}"
  #         fi
  #         echo "version=$VERSION" >> $GITHUB_OUTPUT
  #         echo "üì¶ Building version: $VERSION"

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3

  #     - name: Build Alpine package in Docker
  #       run: |
  #         VERSION="${{ steps.version.outputs.version }}"
  #         ARCH="${{ matrix.arch }}"

  #         # Create build script for Alpine container
  #         cat > build-apk.sh << 'SCRIPT'
  #         #!/bin/sh
  #         set -e

  #         # Install build dependencies
  #         apk add --no-cache \
  #           bash \
  #           python3 \
  #           py3-pip \
  #           python3-dev \
  #           gcc \
  #           musl-dev \
  #           libffi-dev \
  #           openssl-dev \
  #           zlib-dev \
  #           alpine-sdk \
  #           sudo

  #         # Create packager user (required by abuild)
  #         adduser -D packager
  #         addgroup packager abuild
  #         echo "packager ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

  #         # Install Python dependencies
  #         pip3 install --break-system-packages pyinstaller
  #         pip3 install --break-system-packages -e ".[build]"

  #         # Build binary
  #         chmod +x build.sh
  #         ./build.sh

  #         # Verify binary
  #         ./dist/cyberwave-cli --help || true

  #         # Create APKBUILD
  #         mkdir -p /home/packager/apk-build
  #         cd /home/packager/apk-build

  #         cat > APKBUILD << EOF
  #         # Maintainer: Cyberwave <support@cyberwave.com>
  #         pkgname=cyberwave-cli
  #         pkgver=${VERSION}
  #         pkgrel=0
  #         pkgdesc="The official command-line interface for Cyberwave"
  #         url="https://cyberwave.com"
  #         arch="${ARCH}"
  #         license="MIT"
  #         options="!check"

  #         package() {
  #           install -Dm755 /workspace/dist/cyberwave-cli "\$pkgdir/usr/bin/cyberwave-cli"
  #         }
  #         EOF

  #         chown -R packager:packager /home/packager/apk-build
  #         chown -R packager:packager /workspace

  #         # Generate keys and build package
  #         cd /home/packager/apk-build
  #         sudo -u packager abuild-keygen -a -n
  #         sudo -u packager abuild -F

  #         # Copy package to workspace
  #         cp /home/packager/packages/apk-build/${ARCH}/*.apk /workspace/
  #         SCRIPT

  #         chmod +x build-apk.sh

  #         # Run build in Alpine container
  #         docker run --rm \
  #           --platform ${{ matrix.platform }} \
  #           -v "$PWD:/workspace" \
  #           -w /workspace \
  #           -e VERSION="${VERSION}" \
  #           -e ARCH="${ARCH}" \
  #           alpine:3.20 \
  #           /workspace/build-apk.sh

  #         echo "‚úÖ Alpine package built"
  #         ls -la *.apk

  #     - name: Upload .apk artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: apk-${{ matrix.arch }}
  #         path: "*.apk"
  #         retention-days: 7

  publish-to-buildkite:
    name: Publish to Buildkite Package Registries
    runs-on: ubuntu-latest
    needs: [build-deb]
    steps:
      - name: Download all .deb artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          merge-multiple: true
          path: deb-packages

      # - name: Download all .apk artifacts
      #   uses: actions/download-artifact@v4
      #   with:
      #     pattern: apk-*
      #     merge-multiple: true
      #     path: apk-packages

      - name: List downloaded packages
        run: |
          echo "=== Debian packages ==="
          ls -la deb-packages/

      - name: Push Debian packages to Buildkite
        env:
          BUILDKITE_API_TOKEN: ${{ secrets.BUILDKITE_API_TOKEN }}
        run: |
          API_URL="https://api.buildkite.com/v2/packages/organizations/${BUILDKITE_ORG_SLUG}/registries/${BUILDKITE_DEB_REGISTRY_SLUG}/packages"

          for DEB_FILE in deb-packages/*.deb; do
            echo "üì¶ Uploading ${DEB_FILE}..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${API_URL}" \
              -H "Authorization: Bearer ${BUILDKITE_API_TOKEN}" \
              -F "file=@${DEB_FILE}")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ Successfully uploaded ${DEB_FILE}"
            else
              echo "‚ùå Failed to upload ${DEB_FILE} (HTTP ${HTTP_CODE})"
              echo "Response: ${BODY}"
              exit 1
            fi
          done

          echo "‚úÖ All Debian packages uploaded"

      # - name: Push Alpine packages to Buildkite
      #   env:
      #     BUILDKITE_API_TOKEN: ${{ secrets.BUILDKITE_API_TOKEN }}
      #   run: |
      #     API_URL="https://api.buildkite.com/v2/packages/organizations/${BUILDKITE_ORG_SLUG}/registries/${BUILDKITE_APK_REGISTRY_SLUG}/packages"

      #     for APK_FILE in apk-packages/*.apk; do
      #       echo "üì¶ Uploading ${APK_FILE}..."

      #       RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${API_URL}" \
      #         -H "Authorization: Bearer ${BUILDKITE_API_TOKEN}" \
      #         -F "file=@${APK_FILE}")

      #       HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
      #       BODY=$(echo "$RESPONSE" | sed '$d')

      #       if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
      #         echo "‚úÖ Successfully uploaded ${APK_FILE}"
      #       else
      #         echo "‚ùå Failed to upload ${APK_FILE} (HTTP ${HTTP_CODE})"
      #         echo "Response: ${BODY}"
      #         exit 1
      #       fi
      #     done

      #     echo "‚úÖ All Alpine packages uploaded"

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-deb, build-apk]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "{deb,apk}-*"
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.deb
            *.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [publish-to-buildkite, create-github-release]
    if: always()
    steps:
      - name: Post success to Slack
        if: needs.publish-to-buildkite.result == 'success'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: builds
            text: "‚úÖ cyberwave-cli ${{ github.ref_name }} released to APT and Alpine repositories"

      - name: Post failure to Slack
        if: needs.publish-to-buildkite.result == 'failure'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: builds
            text: "‚ùå cyberwave-cli package release failed <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Action Run>"
